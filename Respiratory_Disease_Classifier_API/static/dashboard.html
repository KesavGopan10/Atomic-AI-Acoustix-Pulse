<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Medical AI Platform ‚Äî Admin Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        surface: { 50: '#f8fafc', 100: '#f1f5f9', 700: '#1e293b', 800: '#0f172a', 900: '#020617' },
                    }
                }
            }
        }
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; }
        .sparkline { display: flex; align-items: flex-end; gap: 1px; height: 32px; }
        .sparkline .bar { width: 3px; border-radius: 1px; min-height: 2px; transition: height 0.3s ease; }
        @keyframes pulse-dot { 0%, 100% { opacity: 1; } 50% { opacity: 0.4; } }
        .pulse-dot { animation: pulse-dot 2s ease-in-out infinite; }
        .status-card { transition: all 0.2s ease; }
        .status-card:hover { transform: translateY(-2px); }
    </style>
</head>
<body class="bg-surface-900 text-gray-100 min-h-screen">

    <!-- Header -->
    <header class="border-b border-gray-800 bg-surface-800/80 backdrop-blur-sm sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-6 py-4 flex items-center justify-between">
            <div class="flex items-center gap-3">
                <span class="text-2xl">üè•</span>
                <div>
                    <h1 class="text-lg font-bold">Medical AI Platform</h1>
                    <p class="text-xs text-gray-400">Admin Dashboard</p>
                </div>
            </div>
            <div class="flex items-center gap-4">
                <div id="version-badge" class="px-3 py-1 bg-gray-700/50 rounded-full text-xs font-medium text-gray-300">v2.1.0</div>
                <div class="flex items-center gap-2 text-xs text-gray-400">
                    <span class="w-2 h-2 rounded-full bg-emerald-400 pulse-dot"></span>
                    <span>Auto-refresh <span id="countdown">10</span>s</span>
                </div>
                <button onclick="fetchMetrics()" class="px-3 py-1.5 bg-blue-600 hover:bg-blue-500 rounded-lg text-xs font-medium transition-colors">
                    Refresh Now
                </button>
            </div>
        </div>
    </header>

    <main class="max-w-7xl mx-auto px-6 py-6 space-y-6">

        <!-- Top Stats Row -->
        <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
            <div class="bg-surface-800 border border-gray-700/50 rounded-xl p-4">
                <p class="text-xs text-gray-400 uppercase tracking-wider">Uptime</p>
                <p id="uptime" class="text-2xl font-bold text-white mt-1">‚Äî</p>
            </div>
            <div class="bg-surface-800 border border-gray-700/50 rounded-xl p-4">
                <p class="text-xs text-gray-400 uppercase tracking-wider">Total Requests</p>
                <p id="total-requests" class="text-2xl font-bold text-white mt-1">0</p>
            </div>
            <div class="bg-surface-800 border border-gray-700/50 rounded-xl p-4">
                <p class="text-xs text-gray-400 uppercase tracking-wider">Error Rate</p>
                <p id="error-rate" class="text-2xl font-bold mt-1">0%</p>
            </div>
            <div class="bg-surface-800 border border-gray-700/50 rounded-xl p-4">
                <p class="text-xs text-gray-400 uppercase tracking-wider">Groq Tokens</p>
                <p id="total-tokens" class="text-2xl font-bold text-white mt-1">0</p>
            </div>
        </div>

        <!-- Cache & Groq Row -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
            <div class="bg-surface-800 border border-gray-700/50 rounded-xl p-5">
                <h3 class="text-sm font-semibold text-gray-300 mb-3">üß† Model & Config</h3>
                <div class="space-y-2 text-sm">
                    <div class="flex justify-between"><span class="text-gray-400">ML Model</span><span id="ml-status" class="text-emerald-400">‚Äî</span></div>
                    <div class="flex justify-between"><span class="text-gray-400">Groq LLM</span><span id="groq-status" class="text-emerald-400">‚Äî</span></div>
                    <div class="flex justify-between"><span class="text-gray-400">LLM Model</span><span id="groq-model" class="text-gray-200 text-xs truncate max-w-[180px]">‚Äî</span></div>
                </div>
            </div>
            <div class="bg-surface-800 border border-gray-700/50 rounded-xl p-5">
                <h3 class="text-sm font-semibold text-gray-300 mb-3">üì¶ Cache</h3>
                <div class="space-y-2 text-sm">
                    <div class="flex justify-between"><span class="text-gray-400">Hits</span><span id="cache-hits" class="text-emerald-400">0</span></div>
                    <div class="flex justify-between"><span class="text-gray-400">Misses</span><span id="cache-misses" class="text-amber-400">0</span></div>
                    <div class="flex justify-between"><span class="text-gray-400">Hit Rate</span><span id="cache-hit-rate" class="text-white font-semibold">0%</span></div>
                </div>
            </div>
            <div class="bg-surface-800 border border-gray-700/50 rounded-xl p-5">
                <h3 class="text-sm font-semibold text-gray-300 mb-3">ü™ô Token Usage</h3>
                <div class="space-y-2 text-sm">
                    <div class="flex justify-between"><span class="text-gray-400">Prompt</span><span id="prompt-tokens" class="text-blue-400">0</span></div>
                    <div class="flex justify-between"><span class="text-gray-400">Completion</span><span id="completion-tokens" class="text-purple-400">0</span></div>
                    <div class="flex justify-between"><span class="text-gray-400">Total</span><span id="token-total" class="text-white font-semibold">0</span></div>
                </div>
            </div>
        </div>

        <!-- Endpoint Status Cards -->
        <div>
            <h2 class="text-sm font-semibold text-gray-400 uppercase tracking-wider mb-3">Endpoint Status</h2>
            <div id="endpoints-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                <!-- Dynamically populated -->
            </div>
        </div>

        <!-- Per-Endpoint Detail Table -->
        <div class="bg-surface-800 border border-gray-700/50 rounded-xl overflow-hidden">
            <div class="px-5 py-3 border-b border-gray-700/50">
                <h2 class="text-sm font-semibold text-gray-300">üìä Endpoint Metrics</h2>
            </div>
            <div class="overflow-x-auto">
                <table class="w-full text-sm">
                    <thead>
                        <tr class="text-xs text-gray-400 uppercase tracking-wider border-b border-gray-700/30">
                            <th class="text-left px-5 py-3">Endpoint</th>
                            <th class="text-right px-5 py-3">Requests</th>
                            <th class="text-right px-5 py-3">Errors</th>
                            <th class="text-right px-5 py-3">Error Rate</th>
                            <th class="text-right px-5 py-3">Avg (ms)</th>
                            <th class="text-right px-5 py-3">P95 (ms)</th>
                            <th class="text-center px-5 py-3">Response Times</th>
                            <th class="text-right px-5 py-3">Last Request</th>
                        </tr>
                    </thead>
                    <tbody id="metrics-table-body">
                        <tr><td colspan="8" class="px-5 py-8 text-center text-gray-500">Waiting for data...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>

    </main>

    <!-- Footer -->
    <footer class="border-t border-gray-800 mt-8">
        <div class="max-w-7xl mx-auto px-6 py-4 flex items-center justify-between text-xs text-gray-500">
            <span>Medical AI Platform ‚Äî Admin Dashboard</span>
            <span id="last-updated">Last updated: ‚Äî</span>
        </div>
    </footer>

    <script>
        const REFRESH_INTERVAL = 10; // seconds
        let countdown = REFRESH_INTERVAL;

        const ENDPOINT_META = {
            '/':               { icon: '‚ù§Ô∏è', label: 'Health Check',       tag: 'Health' },
            '/classes':        { icon: 'üìã', label: 'Classes',            tag: 'Health' },
            '/predict':        { icon: 'ü´Å', label: 'Respiratory Predict', tag: 'ML' },
            '/report':         { icon: 'üìã', label: 'Patient Report',     tag: 'LLM' },
            '/heart/analyze':  { icon: 'ü´Ä', label: 'Heart Analysis',     tag: 'LLM' },
            '/scan/analyze':   { icon: 'üî¨', label: 'Medical Imaging',    tag: 'Vision' },
            '/lab/analyze':    { icon: 'üß™', label: 'Lab Reports',        tag: 'Vision' },
            '/symptoms/chat':  { icon: 'üí¨', label: 'Symptom Checker',    tag: 'LLM' },
            '/drugs/check':    { icon: 'üíä', label: 'Drug Interactions',  tag: 'LLM' },
            '/admin/metrics':  { icon: 'üìä', label: 'Metrics',            tag: 'Admin' },
            '/dashboard':      { icon: 'üñ•Ô∏è', label: 'Dashboard',          tag: 'Admin' },
        };

        const TAG_COLORS = {
            'Health': 'bg-emerald-500/20 text-emerald-400',
            'ML':     'bg-blue-500/20 text-blue-400',
            'LLM':    'bg-purple-500/20 text-purple-400',
            'Vision': 'bg-amber-500/20 text-amber-400',
            'Admin':  'bg-gray-500/20 text-gray-400',
        };

        function formatUptime(seconds) {
            const d = Math.floor(seconds / 86400);
            const h = Math.floor((seconds % 86400) / 3600);
            const m = Math.floor((seconds % 3600) / 60);
            const s = seconds % 60;
            if (d > 0) return `${d}d ${h}h ${m}m`;
            if (h > 0) return `${h}h ${m}m ${s}s`;
            return `${m}m ${s}s`;
        }

        function formatNumber(n) {
            if (n >= 1_000_000) return (n / 1_000_000).toFixed(1) + 'M';
            if (n >= 1_000) return (n / 1_000).toFixed(1) + 'K';
            return n.toString();
        }

        function timeAgo(iso) {
            if (!iso) return '‚Äî';
            const diff = (Date.now() - new Date(iso).getTime()) / 1000;
            if (diff < 60) return `${Math.floor(diff)}s ago`;
            if (diff < 3600) return `${Math.floor(diff / 60)}m ago`;
            return `${Math.floor(diff / 3600)}h ago`;
        }

        function buildSparkline(times) {
            if (!times || times.length === 0) return '<span class="text-gray-600 text-xs">No data</span>';
            const max = Math.max(...times, 1);
            return `<div class="sparkline">${times.slice(-30).map(t => {
                const h = Math.max(2, (t / max) * 32);
                const color = t > max * 0.8 ? 'bg-red-400' : t > max * 0.5 ? 'bg-amber-400' : 'bg-emerald-400';
                return `<div class="bar ${color}" style="height:${h}px" title="${t}ms"></div>`;
            }).join('')}</div>`;
        }

        function renderEndpointCards(endpoints, registered) {
            const grid = document.getElementById('endpoints-grid');
            const cards = registered.map(ep => {
                const meta = ENDPOINT_META[ep.path] || { icon: '‚ö™', label: ep.path, tag: 'Other' };
                const stats = endpoints[ep.path];
                const hasTraffic = stats && stats.total_requests > 0;
                const statusColor = !stats ? 'bg-emerald-400' :
                    stats.error_rate > 10 ? 'bg-red-400' :
                    stats.error_rate > 0 ? 'bg-amber-400' : 'bg-emerald-400';
                const tagClass = TAG_COLORS[meta.tag] || TAG_COLORS['Admin'];

                return `
                    <div class="status-card bg-surface-800 border border-gray-700/50 rounded-xl p-4">
                        <div class="flex items-center justify-between mb-2">
                            <div class="flex items-center gap-2">
                                <span class="w-2 h-2 rounded-full ${statusColor} ${!hasTraffic ? 'pulse-dot' : ''}"></span>
                                <span class="text-lg">${meta.icon}</span>
                                <span class="font-medium text-sm">${meta.label}</span>
                            </div>
                            <span class="px-2 py-0.5 rounded-full text-[10px] font-medium ${tagClass}">${meta.tag}</span>
                        </div>
                        <div class="flex items-center justify-between text-xs text-gray-400 mt-2">
                            <span>${ep.method} ${ep.path}</span>
                            <span>${hasTraffic ? stats.avg_response_ms + 'ms avg' : 'Ready'}</span>
                        </div>
                        ${hasTraffic ? `
                        <div class="mt-3 flex items-center justify-between text-xs">
                            <span class="text-gray-400">${formatNumber(stats.total_requests)} req</span>
                            <span class="${stats.total_errors > 0 ? 'text-red-400' : 'text-gray-500'}">${stats.total_errors} err</span>
                        </div>` : ''}
                    </div>`;
            });
            grid.innerHTML = cards.join('');
        }

        function renderMetricsTable(endpoints) {
            const tbody = document.getElementById('metrics-table-body');
            const rows = Object.entries(endpoints)
                .filter(([path]) => !path.startsWith('/static') && path !== '/docs' && path !== '/openapi.json' && path !== '/favicon.ico')
                .sort((a, b) => b[1].total_requests - a[1].total_requests)
                .map(([path, stats]) => {
                    const meta = ENDPOINT_META[path] || { icon: '‚ö™', label: path };
                    const errColor = stats.error_rate > 10 ? 'text-red-400' : stats.error_rate > 0 ? 'text-amber-400' : 'text-gray-500';
                    return `
                        <tr class="border-b border-gray-700/20 hover:bg-gray-700/10 transition-colors">
                            <td class="px-5 py-3 font-medium">${meta.icon} ${path}</td>
                            <td class="px-5 py-3 text-right">${formatNumber(stats.total_requests)}</td>
                            <td class="px-5 py-3 text-right ${stats.total_errors > 0 ? 'text-red-400' : 'text-gray-500'}">${stats.total_errors}</td>
                            <td class="px-5 py-3 text-right ${errColor}">${stats.error_rate}%</td>
                            <td class="px-5 py-3 text-right">${stats.avg_response_ms}</td>
                            <td class="px-5 py-3 text-right text-gray-400">${stats.p95_response_ms}</td>
                            <td class="px-5 py-3">${buildSparkline(stats.recent_response_times)}</td>
                            <td class="px-5 py-3 text-right text-gray-400">${timeAgo(stats.last_request_at)}</td>
                        </tr>`;
                });

            tbody.innerHTML = rows.length > 0 ? rows.join('') :
                '<tr><td colspan="8" class="px-5 py-8 text-center text-gray-500">No requests recorded yet</td></tr>';
        }

        async function fetchMetrics() {
            try {
                const res = await fetch('/admin/metrics');
                const data = await res.json();

                // Top stats
                document.getElementById('uptime').textContent = formatUptime(data.server.uptime_seconds);
                document.getElementById('total-requests').textContent = formatNumber(data.totals.requests);
                const errEl = document.getElementById('error-rate');
                errEl.textContent = data.totals.error_rate + '%';
                errEl.className = `text-2xl font-bold mt-1 ${data.totals.error_rate > 5 ? 'text-red-400' : data.totals.error_rate > 0 ? 'text-amber-400' : 'text-emerald-400'}`;
                document.getElementById('total-tokens').textContent = formatNumber(data.tokens.total);

                // Config
                document.getElementById('ml-status').textContent = '‚úÖ Loaded';
                document.getElementById('groq-status').textContent = data.config.groq_connected ? '‚úÖ Connected' : '‚ùå No Key';
                document.getElementById('groq-status').className = data.config.groq_connected ? 'text-emerald-400' : 'text-red-400';
                document.getElementById('groq-model').textContent = data.config.groq_model.split('/').pop();
                document.getElementById('version-badge').textContent = 'v' + data.config.version;

                // Cache
                document.getElementById('cache-hits').textContent = data.cache.hits;
                document.getElementById('cache-misses').textContent = data.cache.misses;
                document.getElementById('cache-hit-rate').textContent = data.cache.hit_rate + '%';

                // Tokens
                document.getElementById('prompt-tokens').textContent = formatNumber(data.tokens.prompt);
                document.getElementById('completion-tokens').textContent = formatNumber(data.tokens.completion);
                document.getElementById('token-total').textContent = formatNumber(data.tokens.total);

                // Endpoint cards
                renderEndpointCards(data.endpoints, data.registered_endpoints);

                // Table
                renderMetricsTable(data.endpoints);

                // Footer
                document.getElementById('last-updated').textContent = 'Last updated: ' + new Date().toLocaleTimeString();

            } catch (err) {
                console.error('Failed to fetch metrics:', err);
            }
        }

        // Auto-refresh
        setInterval(() => {
            countdown--;
            document.getElementById('countdown').textContent = countdown;
            if (countdown <= 0) {
                countdown = REFRESH_INTERVAL;
                fetchMetrics();
            }
        }, 1000);

        // Initial fetch
        fetchMetrics();
    </script>
</body>
</html>
